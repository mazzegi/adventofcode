package jigsaw

import (
	"fmt"
	"strings"
)

func (t Tile) onesCount() int {
	var cnt int
	for _, row := range t.rows {
		for _, v := range row {
			if v > 0 {
				cnt++
			}
		}
	}
	return cnt
}

type pos struct {
	row, col int
}

func (t Tile) containsTileAt(row, col int, ct Tile) (map[pos]bool, bool) {
	positions := map[pos]bool{}
	for crow := 0; crow < len(ct.rows); crow++ {
		for ccol := 0; ccol < len(ct.rows[crow]); ccol++ {
			cval := ct.rows[crow][ccol]
			if cval == 0 {
				continue
			}

			trow := row + crow
			tcol := col + ccol
			if trow >= len(t.rows) {
				return nil, false
			}
			if tcol >= len(t.rows[trow]) {
				return nil, false
			}
			tval := t.rows[trow][tcol]
			if tval != cval {
				return nil, false
			}
			positions[pos{
				row: trow,
				col: tcol,
			}] = true
		}
	}
	return positions, true
}

func parseMonsterTile() (Tile, error) {
	var sl []string
	sp := strings.Split(Monster, "\n")
	for _, s := range sp {
		s = strings.Trim(s, " \r\n\t")
		if s == "" {
			continue
		}
		sl = append(sl, s)
	}
	return ParseTile(sl, 3, 20)
}

func FindMonster(img string) {
	fmt.Printf("*** find-monster ***\n")
	var sl []string
	sp := strings.Split(img, "\n")
	var dim int
	for _, s := range sp {
		s = strings.Trim(s, " \r\n\t")
		if s == "" {
			continue
		}
		sl = append(sl, s)
	}
	dim = len(sl[len(sl)-1])
	imgTile, err := ParseTile(sl, dim, dim)
	if err != nil {
		panic(err)
	}
	monsterTile, err := parseMonsterTile()
	if err != nil {
		panic(err)
	}
	var mcnt int
	positions := map[pos]bool{}
	for _, trans := range AllTransforms() {
		imgTrans := imgTile.Transformed(trans)
		for row := 0; row < dim; row++ {
			for col := 0; col < dim; col++ {
				tilePositions, ok := imgTrans.containsTileAt(row, col, monsterTile)
				if ok {
					fmt.Printf("found monster at (%d, %d) for %q\n", row, col, trans)
					mcnt++
					for pos := range tilePositions {
						positions[pos] = true
					}
				}
			}
		}
		if mcnt > 0 {
			break
		}
	}

	oc := imgTile.onesCount()
	fmt.Printf("the image contains %d monsters\n", mcnt)
	fmt.Printf("there are %d #s total\n", oc)
	fmt.Printf("there are %d monster #s\n", len(positions))

	fmt.Printf("roughness: %d\n", oc-len(positions))
}

var Monster = `
Tile 666:
..................#.
#....##....##....###
.#..#..#..#..#..#...
`

var ImageTest = `
Tile 1:
.####...#####..#...###..
#####..#..#.#.####..#.#.
.#.#...#.###...#.##.##..
#.#.##.###.#.##.##.#####
..##.###.####..#.####.##
...#.#..##.##...#..#..##
#.##.#..#.#..#..##.#.#..
.###.##.....#...###.#...
#.####.#.#....##.#..#.#.
##...#..#....#..#...####
..#.##...###..#.#####..#
....#.##.#.#####....#...
..##.##.###.....#.##..#.
#...#...###..####....##.
.#.##...#.##.#.#.###...#
#.###.#..####...##..#...
#.###...#.##...#.######.
.###.###.#######..#####.
..##.#..#..#.#######.###
#.#..##.########..#..##.
#.#####..#.#...##..#....
#....##..#.#########..##
#...#.....#..##...###.##
#..###....##.#...##.##.#
`

var Image = `
Tile 2:
.#.#.#..#.#..#.........#.....#...#........#...#...#....#.#...............#..###.##....#.........
#...............#...#.#....#.......###..#.....##..##.........#.......#.#.....................#..
#.....................#........#........#....##.#.#..#......#..#..........#...........#.#..#...#
.......#.#..#.#.#...#..#......##.#.#..#.##.#....#......#...#...#.#.......#.......#.....#..#.....
..............##....#..##..............##.......#.#..#...#.....#................#.#....#...#....
#.#.........#......#....#..............#.......#........#...........##......#.......#......###..
......................##...........#.#........###.#....#....#...#....#.#...#.#..#...#.....##..#.
.#.#....##.......#.................##.#..##......#.........#....#.....###.#......##..#.##.#.....
...........#.#.#..#...........#...##.###......##......#..............#.#.....#......#.......#.#.
.#...##............#.......#....#.#.##..#.........#..............##...####.#.###..........#.....
#....#........#...##.....#..#...#..#....#..#.........................#..#....###........#.#.#..#
..........#..#.#.........#.............#...#...#....#..#.#.................####.#..........#.#.#
.##......#.....#....##....##...#..#........#.#..##.##.......#....#....#..#....##.........###...#
..#..##......#......##..#......#...#.......#..............#..#.........#................###.#..#
.....#...#..##..#..##..............#.####.............#.#.###..........#....#......#..##....#...
........#.#........#..#.#...#..#..##...##...#........#....#......#..#.#....#.##...#.............
#....#.#......#.........#...........#...#.#....#.....#...#...........##..#...#.#.....#....#.#...
......#....................#..#.....#.##........#.....#..........#....#...#.##...........#.##...
...#........#....#.#.....#........##.#...............#.......#...#...##........#...........##...
.#.....#.#.#.....#..#.....##.......#.....#.......#......#..#.#...#.....#.#.......#..#.#...#.....
.###..##....###...#.#...#...#.....##...#.......#...#..............#...###...#......#........##..
..#.#...##.....##..#..........#...#....##.##.........#..............#.#.....###...#.#.....#.....
#.......#....#####.#..#..#.....#........#....#....#.#.............#.....###..##.##........##..#.
....#.........##...#...#.......#......###..##.#....#.............#......##..#.#..........###....
...........#..#....##..#.#.......##....#......#........#.#...#........#........#........#.#.....
..........#.......#.#......#...#...#...##.##.#........#...#.#..##.#....#.....#..................
.#.#.........#.....###......#..........#......#.#....#.........###..........#.###........#..##..
#..#.........##....##.....#...#.#.....#....#.#.#...#....#.....#..#....#.....###....#.#.......##.
.....#.#.......#.......###....##.....#...#..#.#.........#...##.....#........##..#.....#.#.....#.
.##....#.......#..#......##..........#...#...#.........#...............#.........#...#..........
...#....#.....#....##..#.#..#..#......#.##.......#..........#.#.........##....#..#.......#......
....#........##.#...#...#...#..#..#....#..#....#....#.............#..#..##.......#.#............
...............#.#.#........#..........#.#.#.#.##.......#.....#.#....###.......................#
..........#...#..#.......#.#..#...##.##........#.....##..#....#...........................#.....
...#....###..#.#.....####.....#.....#.........#.#......#.......#.#........#...............#.....
..#.##..#......#...#.....#....#.........#.........#............#....#....#......#...#....#....#.
#...#.......####........##...#..#.#..###........................#..#............................
........##............#.#.........#..#.#..#...##.........#......#....#.......#.#................
#....#.#...#..#.#.##....##....#......#.#...#...#.#...........#.....#..#.#...#..#........##....#.
...##..#......#.#...#.#...##.#........##..#.##.#.......#.........#.............##........##.....
....##........###.......#.......#...#........##................#.#...........#.#.........#......
##.##...#.....#.....#..#.#.........................................#.#........#....#..#.#.#.....
.###..#......#...#...##..#..#......#.##......#..........##........#....#....#.....#............#
...#......#.............#......#..#..#.#...#..#.#...............#..#.#.#......##.........#....#.
.........#..#.....##.....#.....#.......#..#....#.#..##.#..##..#...##.#.......###.......##.#.....
...#.#.#..........##..#.............#..........##....#...#..#.....#.#..#....#..#.........##.#...
....#.#...............#.#....#.....#..........#..#....#....#.....#......#..##..#........##.....#
..#.#........#.....#....##....#.........#....#.....#...##...#...#...#.....#.###.........#..##...
..##..#.#...................#....#............#...#.#.#..#..##...#..........#...##.#.#..#...#...
.........#..#..........#.........#......#....##............#...#......#........###.......#......
.#...#.....#........#...#......................#............#....##.#....#..#.#.#......##..#.##.
..##..#..##.....##..#.....#......##.#.....#.......#.....#...#....##............#.........#......
....#..#.....##.##....##......##..##..#..##.#....#.............#.#.....#..#....#..#......#.#....
....#.....................#...#.....#...#.....#...#...#....##...#...##....#...##........#......#
...#..................#.#...#.......#.....#..#...###........#...#...........##.#..##.....##.....
...#...#......#.....#..##...............##..#.....##.............#.......#.#..####....#.........
............#.....##...............#....#........#..........#...#..#.....#.#..#........##.#..#..
.#.#..##...#........#......#........#.......#........#...##.#.#..#.#.##.##....##.......#.#......
#...#.#.....###.#.............#.....#..#.........#........#......###....#.........#........#..#.
.....#....#.#....#.##....#.#.#..##.....#...#.#...#..#.....##...##.........#.#..#.#....#...#.#...
....#.........##..........#...#..##.#...#....#....####....#..##.............#......#.........#.#
#..#......#..#.....................#....#.........#......#......#.#.#..#....................#...
....#.....##.........#.....................##....#.#.#....#..#..#....#..#.#.#.#.#.#...#.......##
.###...#..#.......................#.##.#......#....#...#.........#..................#..#.......#
..............#.#..#.##..#.#.........#......#..#..##...#.##......#......#.......#..#.....#......
......#......#.....##.................#.......#.##...#...##.....##..###.#..#..........##...#.#..
.......#.#......#......#.........##...#..#.#..#...#....#..#.....#......#...#....#..#............
.....#.........#.#......##...#.#......#...#.##.#..#......#..#....#........#...#..........#..#...
.#...#...........#.....##........#.....#......##.#....##...#....#..........###...........##....#
....##...#....#.###....#.................#.....#..#......#...#.#.#........#.................#...
#............#......#.#............#........#.#..###...###..#............#.......#...#......##..
......#.....#.#.##...............................##.......#.#........##....#...#.##.........#...
..##..........##.........#..#..##............#..#.#.#.....#........#.........#.#.#..#......###..
#......#......#...##...#.............#................#..#.###...........#....#.#.........#.....
#.........#..##...##.#.....#.#.....#....#..........#.....##...............#...#.................
..............#..#.....#........#..##..............#...........#......#..............#.##.####..
.#.#......#......#.#...............#.........#...#..#.##.#........#......#......##..#.......#...
.#.........###..#.#...........###.#.#..#................#.#..........#..#..#...###.......#.###..
#...#.....#.#.#.##......#.#..............#......#..#..............#...#..#......##..#......#..#.
......#.......##.#...#.#..........#..#........##......#...#.#.........#.........#.......#.#...#.
........#....#.#.#................#.#...#........##.#...##.#.....#.#..#....#.#..#.......#.#.#...
..##...#...#..##.#.......#.........#...........................#..#................#.#..#..#...#
.......##.#...#...#........#.##...##.#.#............#.........#.......#.......#.#......#....#...
.............#..#.##.....###...#..#.....................#....##........#......#..##...#.....#...
....#.........#..............##..#...#...........................#..#........#...#....#...##.##.
#..##.....#...#..#........................##.##.##.#.....##......#...#.......##.#...........###.
..##...#..#.##.....#.#........#...#......#...#.....#..#.....#........##.................#......#
#....#........#.#.................##......#....##.......#...#.#..#.....#..##..#........#...#....
.#...........#.#..##...............#..##.......##.............##.#..#.#..##.....#...........#...
............###.....#...#...#.....#......#...##.......#....#.........#...#.......#..#.#....#....
..##..........#.......#.#.......#........#..#.#..##......#...........#...#......#.#.............
..#...#........................#......#...#....#...............#....#.#..##......#..#...........
..#........................#.....##.........###...#........#.###......#....#.#...#..............
.#............#......#..#..#......##.#..#..#.....#...#...............#.#...........#............
.............#.#....#....#....#..........#......##...........#.#..#.#.....#...#...#...##........
.#......#...#...#....#.............#....................#..#..#........#..##........#..#........
`
